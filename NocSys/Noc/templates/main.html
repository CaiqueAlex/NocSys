{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NocSys</title>
<link rel="icon" type="image/png" href="{% static 'css/Nocsyslogo.png' %}">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/main.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>

<!-- BARRA SUPERIOR E ANIMA√á√ÉO -->
<div class="top-bar fade-slide-down">
    <div class="top-bar-left">
        {% if user.is_authenticated %}
        <button id="menu-toggle-btn" class="menu-toggle-btn" title="Alternar menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        {% endif %}
        <div class="logo-login">NocSys</div>
        {% if user.is_authenticated %}
        <div id="logo-animation-container">
            <span id="typing-text"></span><span id="blinking-cursor"></span>
            <div id="face-emoji">
                <div class="face-eye left"></div>
                <div class="face-eye right"></div>
                <div class="face-mouth"></div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="top-bar-right">
        {% if user.is_authenticated %}
        <button id="settings-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
        {% endif %}
        <div class="clock" id="clock">--:--:--</div>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </div>
</div>
<div id="lightbulb-anim-container">
    <div id="lightbulb">üí°</div>
</div>

{% if user.is_authenticated %}
  <!-- CONTE√öDO DA HOME (AUTENTICADO) -->
  <div id="csrf-container" style="display: none;">{% csrf_token %}</div>
  <div class="main-container" id="main-container">
      <div class="sidebar" id="sidebar">
        <div class="logo">
          <img src="{% static 'css/Nocsyslogo.png' %}" alt="NocSys Logo" class="sidebar-logo-img">
          <span>NocSys</span>
        </div>
        <ul class="menu">
          <li><a href="#" id="menu-dashboard">üè† Dashboard</a></li>
          <li><a href="#" id="menu-chamados-abertos">üü° Chamados em Aberto</a></li>
          <li><a href="#" id="menu-chamados-finalizados">üìä Chamados Finalizados</a></li>
          <li><a href="{% url 'logout' %}">üö™ Sair</a></li>
        </ul>
      </div>
      <div class="content" id="content-area">
          <!-- O conte√∫do ser√° carregado aqui -->
      </div>
  </div>

{% else %}
  <!-- CONTE√öDO DE LOGIN (N√ÉO AUTENTICADO) -->
  <div class="login-page-container fade-zoom-in">
    <div class="login-box fade-zoom-in" id="login-box">
      <h2 class="titlelogin">NocSys - Login</h2>
      {% if error %}
        <p class="error">{{ error }}</p>
      {% endif %}
      <form method="post" action="{% url 'main' %}" id="login-form">
        {% csrf_token %}
        <input type="text" name="username" placeholder="Usu√°rio" required autocomplete="username" />
        <input type="password" name="password" placeholder="Senha" required autocomplete="current-password" />
        <button type="submit">Entrar</button>
      </form>
    </div>
  </div>
{% endif %}

<!-- MODAIS -->
<div id="inactive-prompt-container">
    <div class="speech-bubble">
        <p id="inactive-prompt-text"></p>
    </div>
    <div class="prompt-character">ü§î</div>
</div>
<div id="confirm-delete-backdrop" class="modal-backdrop hidden">
    <div id="confirm-delete-box" class="modal-box">
        <div id="confirm-initial-view">
            <h2 id="confirm-delete-title"></h2>
            <div class="modal-buttons">
                <button id="confirm-delete-no-btn">N√£o, mudei de ideia!</button>
                <button id="confirm-delete-yes-btn">Sim, pode apagar!</button>
            </div>
        </div>
        <div id="confirm-success-view" class="hidden">
            <p style="font-size: 1.5rem; text-align: center;">Apagado! ‚úÖ</p>
        </div>
    </div>
</div>
<div id="confirm-finalize-backdrop" class="modal-backdrop hidden">
    <div id="confirm-finalize-box" class="modal-box">
        <div id="confirm-initial-view-finalize">
            <h2 id="confirm-finalize-title"></h2>
            <div class="modal-buttons">
                <button id="confirm-finalize-no-btn">Cancelar</button>
                <button id="confirm-finalize-yes-btn">Sim, finalizar chamado!</button>
            </div>
        </div>
        <div id="confirm-finalize-success-view" class="hidden">
            <p style="font-size: 1.5rem; text-align: center;">Chamado Finalizado! ‚úîÔ∏è</p>
        </div>
    </div>
</div>
<div id="edit-chamado-backdrop" class="modal-backdrop hidden">
    <div id="edit-chamado-box" class="modal-box">
        <button id="edit-chamado-close-btn" class="modal-close-btn">&times;</button>
        <div id="edit-chamado-form-view">
            <h2>Editar Chamado #<span id="edit-chamado-codigo"></span></h2>
            <form id="edit-chamado-form" class="detalhes-suporte-container" style="margin-top: 1rem; padding: 0;">
                <div class="detalhes-grid edit-grid">
                    <span>Suporte:</span>
                    <div class="suporte-field-container">
                        <select name="suporte" id="suporte-select"></select>
                        <button type="button" id="assign-to-me-btn" title="Atribuir a mim">üë§</button>
                    </div>
                    <span>Cliente:</span> <input name="cliente" readonly />
                    <span>Setor:</span> <input name="setor" readonly />
                    <span>Resumo:</span> <input name="resumo" />
                    <span>Problema:</span> <textarea name="problema" rows="3"></textarea>
                    <span>Solu√ß√£o:</span> <textarea name="solucao" rows="3"></textarea>
                    
                    <span>Observa√ß√µes:</span>
                    <button type="button" id="open-obs-editor-btn" class="btn-obs">Ver / Editar Observa√ß√µes</button>

                    <span>Indicador:</span>
                    <select name="indicador">
                        <option value="">Selecione...</option>
                        <option value="Requisi√ß√£o">Requisi√ß√£o</option>
                        <option value="Incidente">Incidente</option>
                    </select>
                    <span>Tempo Solu√ß√£o:</span> <input name="tempo_solucao" readonly />
                </div>
                <div class="modal-buttons">
                    <button type="submit" id="edit-chamado-save-btn">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
        <div id="edit-chamado-success-view" class="hidden">
            <p style="font-size: 1.5rem; text-align: center;">Altera√ß√µes salvas! ‚úÖ</p>
        </div>
    </div>
</div>
<div id="settings-backdrop" class="modal-backdrop hidden">
    <div id="settings-box" class="modal-box">
        <div class="settings-container fade-in">
            <div class="settings-sidebar">
                <h3>Configura√ß√µes</h3>
                <ul>
                    <li><a href="#" class="settings-nav-link active" data-target="settings-view-user">üë§ Usu√°rio</a></li>
                    <li><a href="#" class="settings-nav-link" data-target="settings-view-clientes">üë• Clientes</a></li>
                    <li><a href="#" class="settings-nav-link" data-target="settings-view-graficos">üìà Gr√°ficos</a></li>
                </ul>
            </div>
            <div class="settings-content">
                <button id="settings-close-btn" class="modal-close-btn">&times;</button>
                <div id="settings-view-user" class="settings-view">
                    <h2>Detalhes do Usu√°rio</h2>
                    <div class="user-details-grid">
                        <span>Nome Completo:</span> <strong id="settings-user-name">Carregando...</strong>
                        <span>Email:</span> <strong id="settings-user-email">Carregando...</strong>
                        <span>Usu√°rio:</span> <strong id="settings-user-username">Carregando...</strong>
                        <hr>
                        <span>Membro desde:</span> <strong id="settings-user-joined">Carregando...</strong>
                        <span>Chamados Finalizados:</span> <strong id="settings-finalizados-count">Carregando...</strong>
                    </div>
                </div>
                <div id="settings-view-clientes" class="settings-view hidden">
                    <div class="client-view-header">
                        <h2>Gerenciar Clientes</h2>
                        <button id="add-client-btn" class="btn-add-client">‚ûï Adicionar Cliente</button>
                    </div>
                    <div class="client-table-container">
                        <table id="client-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>N√∫mero</th>
                                    <th>Setor</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="client-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="settings-view-graficos" class="settings-view hidden">
                    <h2>Estat√≠sticas de Desempenho</h2>
                    <div id="charts-container">
                        <!-- O conte√∫do (tabela ou resumo) ser√° renderizado aqui pelo JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="cliente-modal-backdrop" class="modal-backdrop hidden">
    <div id="cliente-modal-box" class="modal-box">
        <button id="cliente-modal-close-btn" class="modal-close-btn">&times;</button>
        <h2 id="cliente-modal-title">Adicionar Novo Cliente</h2>
        <form id="cliente-form" class="detalhes-suporte-container" style="margin-top: 1rem; padding: 0;">
            <input type="hidden" name="id">
            <div class="detalhes-grid">
                <span>Nome:</span>
                <input name="nome" placeholder="Nome completo do cliente" required />
                <span>N√∫mero:</span>
                <input name="numero" placeholder="Ex: 5514912345678" pattern="[0-9]{13}" title="Apenas n√∫meros, 13 d√≠gitos (55+DDD+N√∫mero)" required />
                <span>Setor:</span>
                <input name="setor" placeholder="Setor do cliente (Opcional)" />
            </div>
            <div class="modal-buttons">
                <button type="submit" id="cliente-form-save-btn">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="fullscreen-convo-backdrop" class="modal-backdrop hidden">
    <div id="fullscreen-convo-box" class="modal-box">
        <button id="fullscreen-convo-close-btn" class="modal-close-btn">&times;</button>
        <div id="fullscreen-convo-content"></div>
    </div>
</div>

<!-- MODAL PARA GR√ÅFICOS EM TELA CHEIA -->
<div id="charts-fullscreen-backdrop" class="modal-backdrop hidden">
    <div id="charts-fullscreen-box" class="modal-box">
        <button id="charts-fullscreen-close-btn" class="modal-close-btn">&times;</button>
        <h2>Visualiza√ß√£o de Gr√°ficos</h2>
        <div id="charts-fullscreen-content">
            <!-- Gr√°ficos ser√£o renderizados aqui pelo JS -->
        </div>
    </div>
</div>

<div id="obs-modal-backdrop" class="modal-backdrop hidden">
    <div id="obs-modal-box" class="modal-box">
        <button id="obs-modal-close-btn" class="modal-close-btn">&times;</button>
        <h2>Observa√ß√µes Internas do Chamado #<span id="obs-chamado-codigo"></span></h2>
        <div id="obs-list-container"></div>
        <div id="obs-attachment-preview-container"></div>
        <div id="obs-input-bar">
            <button id="obs-attach-btn" title="Anexar arquivo">üìé</button>
            <input type="file" id="obs-file-input" class="hidden">
            <div id="obs-text-input" contenteditable="true" data-placeholder="Digite sua observa√ß√£o..."></div>
            <button id="obs-mic-btn" title="Gravar √°udio (em breve)" disabled>üé§</button>
            <button id="obs-send-btn" title="Enviar">‚ñ∂Ô∏è</button>
        </div>
    </div>
</div>


<!-- SCRIPTS -->
<script src="{% static 'js/dashboard.js' %}"></script>
<script src="{% static 'js/abertos.js' %}"></script>
<script src="{% static 'js/chamados_finalizados.js' %}"></script>
<script src="{% static 'js/config.js' %}"></script>

<script>
  // --- FUN√á√ïES GLOBAIS AUXILIARES ---
  let currentUser = null;

  function escapeHtml(text) {
    if (typeof text !== 'string') return '';
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
  }

  function niceDate(dateString) {
    if (!dateString) return 'Data inv√°lida';
    const date = new Date(dateString);
    if (isNaN(date)) return 'Data inv√°lida';
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${day}/${month}/${year} ${hours}:${minutes}`;
  }

  function renderMessageContent(m) {
    let content = '';
    const textContent = m.text && m.msg_type !== 'document' ? `<p class="media-caption">${escapeHtml(m.text)}</p>` : '';

    switch (m.msg_type) {
        case 'image':
            content = `<div class="media-container"><img src="${m.media_file}" alt="Imagem enviada" loading="lazy"></div>${textContent}`;
            break;
        case 'video':
            content = `<div class="media-container"><video src="${m.media_file}" controls></video></div>${textContent}`;
            break;
        case 'audio':
            content = `<audio src="${m.media_file}" controls></audio>${textContent}`;
            break;
        case 'document':
            content = `<a href="${m.media_file}" class="document-link" download>
                           <span class="document-icon">üìÑ</span>
                           <span class="document-name">${escapeHtml(m.text || 'Documento')}</span>
                       </a>`;
            break;
        case 'text':
        default:
            content = `<p>${escapeHtml(m.text || '[Mensagem vazia]')}</p>`;
            break;
    }
    return content;
  }

  function getCsrfToken() {
    const csrfInput = document.querySelector('#csrf-container [name="csrfmiddlewaretoken"]') || document.querySelector('#login-form [name="csrfmiddlewaretoken"]');
    return csrfInput ? csrfInput.value : '';
  }

  function showConversationFullscreen(convoContainer) {
      const backdrop = document.getElementById('fullscreen-convo-backdrop');
      const contentBox = document.getElementById('fullscreen-convo-content');
      const closeBtn = document.getElementById('fullscreen-convo-close-btn');

      if (!backdrop || !contentBox || !closeBtn || !convoContainer) return;
      
      contentBox.innerHTML = '';
      const clonedContent = convoContainer.cloneNode(true);
      contentBox.appendChild(clonedContent);

      const hide = () => backdrop.classList.add('hidden');
      
      closeBtn.onclick = hide;
      backdrop.onclick = (e) => {
          if (e.target === backdrop) hide();
      };

      backdrop.classList.remove('hidden');
  }

  async function showEditModal(codigo) {
    const backdrop = document.getElementById('edit-chamado-backdrop');
    const formView = document.getElementById('edit-chamado-form-view');
    const successView = document.getElementById('edit-chamado-success-view');
    const form = document.getElementById('edit-chamado-form');
    const closeBtn = document.getElementById('edit-chamado-close-btn');
    const suporteSelect = document.getElementById('suporte-select');
    const assignBtn = document.getElementById('assign-to-me-btn');
    const openObsBtn = document.getElementById('open-obs-editor-btn');

    formView.classList.remove('hidden', 'content-hiding');
    successView.classList.add('hidden');
    backdrop.classList.remove('hidden');
    document.getElementById('edit-chamado-codigo').textContent = codigo;
    form.reset();

    const saveBtn = document.getElementById('edit-chamado-save-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Carregando...';

    const isFinalizadoElement = document.getElementById(`chamado-${codigo}`);
    const isFinalizado = isFinalizadoElement && isFinalizadoElement.closest('#content-area').querySelector('h1')?.textContent.includes('Finalizados');
    
    try {
        const usersRes = await fetch('/api/users/');
        if (!usersRes.ok) throw new Error('Falha ao carregar lista de usu√°rios.');
        const users = await usersRes.json();
        
        suporteSelect.innerHTML = '<option value="">Selecione...</option>';
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            suporteSelect.appendChild(option);
        });

        const res = await fetch(`/api/whatsapp-slots/?finalizado=${isFinalizado ? 1 : 0}`);
        if (!res.ok) throw new Error('Falha ao carregar dados do chamado.');
        
        const chamados = await res.json();
        const ultimoSlot = chamados.find(s => s.codigo_chamado === codigo);

        if (ultimoSlot) {
            form.elements.suporte.value = ultimoSlot.suporte || '';
            form.elements.cliente.value = ultimoSlot.cliente || '';
            form.elements.setor.value = ultimoSlot.setor || '';
            form.elements.resumo.value = ultimoSlot.resumo || '';
            form.elements.problema.value = ultimoSlot.problema || '';
            form.elements.solucao.value = ultimoSlot.solucao || '';
            form.elements.indicador.value = ultimoSlot.indicador || '';
            form.elements.tempo_solucao.value = ultimoSlot.tempo_solucao || (isFinalizado ? 'N/A' : 'Ainda em aberto');
            openObsBtn.onclick = () => showObservacoesModal(codigo);
        }
        saveBtn.disabled = false;
        saveBtn.textContent = 'Salvar Altera√ß√µes';

    } catch (error) {
        console.error("Erro ao popular formul√°rio de edi√ß√£o:", error);
        alert(error.message);
        backdrop.classList.add('hidden');
        return;
    }

    const hide = () => { backdrop.classList.add('hidden'); };
    
    const assignToMe = async () => {
        try {
            if (!currentUser || !currentUser.username) {
                const res = await fetch('/api/user/stats/');
                if (!res.ok) throw new Error('Falha ao obter dados do usu√°rio logado.');
                currentUser = await res.json();
            }
            suporteSelect.value = currentUser.username;
        } catch(error) { alert(error.message); }
    };

    const handleSave = async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        saveBtn.disabled = true;
        saveBtn.textContent = 'Salvando...';

        try {
            const response = await fetch(`/api/chamado/atualizar/${codigo}/`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify(data),
            });
            if (!response.ok) throw new Error('Falha ao salvar as altera√ß√µes.');

            formView.classList.add('content-hiding');
            setTimeout(() => {
                formView.classList.add('hidden');
                successView.classList.remove('hidden');
                setTimeout(() => {
                    hide();
                    if (isFinalizado) { loadChamadosFinalizados(); } 
                    else { loadAbertos(); }
                }, 1200);
            }, 300);

        } catch (error) {
            console.error('Erro ao salvar:', error);
            alert(error.message);
            saveBtn.disabled = false;
            saveBtn.textContent = 'Salvar Altera√ß√µes';
        }
    };
    
    const cleanupListeners = () => {
        form.removeEventListener('submit', handleSave);
        closeBtn.removeEventListener('click', handleClose);
        assignBtn.removeEventListener('click', assignToMe);
    };
    const handleClose = () => { hide(); cleanupListeners(); };
    
    form.addEventListener('submit', handleSave);
    closeBtn.addEventListener('click', handleClose);
    assignBtn.addEventListener('click', assignToMe);
  }
  
  // --- NOVAS FUN√á√ïES PARA O MODAL DE OBSERVA√á√ïES ---
  let currentObsCodigo = null;
  let obsFileAttachment = null; // Guarda o arquivo a ser enviado

  function renderObservacao(obs) {
    const isSelf = obs.autor_username === currentUser.username;
    const obsClass = isSelf ? 'suporte' : 'cliente';
    
    let content = '';
    
    if (obs.media_file) {
        if (obs.msg_type === 'image') {
            content += `<div class="media-container"><img src="${obs.media_file}" alt="Imagem" loading="lazy"></div>`;
        } else {
            // Tenta pegar o nome original do arquivo. Se n√£o houver, usa o nome do path.
            const fileName = obs.texto || obs.media_file.split('/').pop();
            content += `<a href="${obs.media_file}" class="document-link" download>
                           <span class="document-icon">üìÑ</span>
                           <span class="document-name">${escapeHtml(fileName)}</span>
                       </a>`;
        }
    }
    
    // Renderiza o texto se houver, e se n√£o for um documento (onde o texto j√° foi usado como nome)
    if(obs.texto && obs.msg_type !== 'document') content += `<p>${escapeHtml(obs.texto)}</p>`;

    return `
        <div class="mensagem ${obsClass}">
            <div class="mensagem-header">
                <span>${escapeHtml(obs.autor_username)}</span>
                <span>${niceDate(obs.criado_em)}</span>
            </div>
            ${content || '<p>[Mensagem vazia]</p>'}
        </div>
    `;
  }

  async function fetchAndRenderObservacoes(codigo) {
    const obsListContainer = document.getElementById('obs-list-container');
    obsListContainer.innerHTML = '<p>Carregando observa√ß√µes...</p>';
    try {
        const response = await fetch(`/api/chamado/${codigo}/observacoes/`);
        if (!response.ok) throw new Error('Falha ao carregar observa√ß√µes.');
        const observacoes = await response.json();
        
        if (observacoes.length === 0) {
            obsListContainer.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhuma observa√ß√£o interna registrada.</p>';
        } else {
            obsListContainer.innerHTML = observacoes.map(renderObservacao).join('');
        }
        obsListContainer.scrollTop = obsListContainer.scrollHeight;
    } catch (err) {
        obsListContainer.innerHTML = `<p style="color:var(--danger-color);">${err.message}</p>`;
    }
  }

  async function showObservacoesModal(codigo) {
    currentObsCodigo = codigo;
    const backdrop = document.getElementById('obs-modal-backdrop');
    document.getElementById('obs-chamado-codigo').textContent = codigo;
    
    if (!currentUser || !currentUser.username) {
        const userRes = await fetch('/api/user/stats/');
        if (userRes.ok) currentUser = await userRes.json();
    }
    
    await fetchAndRenderObservacoes(codigo);
    backdrop.classList.remove('hidden');
  }

  function typeWriter(element, text, speed) {
      return new Promise((resolve) => {
          let i = 0;
          element.innerHTML = '';
          const cursor = '<span class="cursor"></span>';
          element.innerHTML = cursor;
          function type() {
              if (i < text.length) {
                  element.innerHTML = text.substring(0, i + 1) + cursor;
                  i++;
                  setTimeout(type, speed);
              } else {
                  element.innerHTML = text;
                  resolve();
              }
          }
          type();
      });
  }

  const deletePhrases = [
        "Tem certeza? üòï Apagar o chamado #{codigo} √© um caminho sem volta... tipo meia perdida na m√°quina de lavar.",
        "Certeza mesmo? üßê O chamado #{codigo} ser√° enviado para o v√°cuo c√≥smico, de onde nada retorna.",
        "√öltima chance! üò¨ Clicar em 'Sim' vai deletar o chamado #{codigo} mais r√°pido que um piscar de olhos.",
        "Pense bem... O hist√≥rico do chamado #{codigo} est√° prestes a virar poeira digital. Continuar?",
        "Alerta! üö® O chamado #{codigo} ser√° permanentemente exclu√≠do. N√£o temos um 'desfazer' para isso."
    ];

  function showDeleteConfirmModal(codigo) {
      const backdrop = document.getElementById('confirm-delete-backdrop');
      const title = document.getElementById('confirm-delete-title');
      const noBtn = document.getElementById('confirm-delete-no-btn');
      const yesBtn = document.getElementById('confirm-delete-yes-btn');
      
      backdrop.querySelector('#confirm-initial-view').classList.remove('hidden', 'content-hiding');
      backdrop.querySelector('#confirm-success-view').classList.add('hidden');
      backdrop.classList.remove('hidden');

      const message = deletePhrases[Math.floor(Math.random() * deletePhrases.length)].replace('{codigo}', codigo);
      typeWriter(title, message, 25);

      return new Promise(resolve => {
          const handleYesClick = () => { resolve(true); cleanup(); };
          const handleNoClick = () => { backdrop.classList.add('hidden'); resolve(false); cleanup(); };
          const cleanup = () => {
              yesBtn.removeEventListener('click', handleYesClick);
              noBtn.removeEventListener('click', handleNoClick);
          };
          yesBtn.addEventListener('click', handleYesClick, { once: true });
          noBtn.addEventListener('click', handleNoClick, { once: true });
      });
  }
  async function apagarChamado(codigo) {
      if (!(await showDeleteConfirmModal(codigo))) return;

      const backdrop = document.getElementById('confirm-delete-backdrop');
      const initialView = document.getElementById('confirm-initial-view');
      const successView = document.getElementById('confirm-success-view');
      
      initialView.classList.add('content-hiding');
      setTimeout(() => {
          initialView.classList.add('hidden');
          successView.classList.remove('hidden');
      }, 300);

      try {
          const response = await fetch(`/api/chamado/apagar/${codigo}/`, {
              method: 'DELETE',
              headers: { 'X-CSRFToken': getCsrfToken() }
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || 'Falha ao apagar o chamado.');
          }
          await new Promise(res => setTimeout(res, 1200));
          backdrop.classList.add('hidden');
          const chamadoElement = document.getElementById(`chamado-${codigo}`);
          if (chamadoElement) {
              chamadoElement.style.transition = 'opacity 0.5s ease';
              chamadoElement.style.opacity = '0';
              setTimeout(() => chamadoElement.remove(), 500);
          }
      } catch (error) {
          backdrop.classList.add('hidden');
          alert(`Erro: ${error.message}`);
          console.error('Erro ao apagar chamado:', error);
      }
  }

  const finalizePhrases = [
      "Pronto para encerrar o chamado #{codigo}? üöÄ O cliente agradece!",
      "Finalizar o chamado #{codigo}? Miss√£o (quase) cumprida. S√≥ falta seu clique.",
      "Bora dar baixa no chamado #{codigo}? ‚úîÔ∏è Mais um pra conta!",
      "Enviar o chamado #{codigo} para a prateleira de 'problemas resolvidos'?",
      "Este chamado lutou o bom combate. Hora do descanso no arquivo de finalizados. Fechar o #{codigo}?"
    ];
  function showFinalizeConfirmModal(codigo) {
      const backdrop = document.getElementById('confirm-finalize-backdrop');
      const title = document.getElementById('confirm-finalize-title');
      const noBtn = document.getElementById('confirm-finalize-no-btn');
      const yesBtn = document.getElementById('confirm-finalize-yes-btn');
      
      backdrop.querySelector('#confirm-initial-view-finalize').classList.remove('hidden', 'content-hiding');
      backdrop.querySelector('#confirm-finalize-success-view').classList.add('hidden');
      backdrop.classList.remove('hidden');

      const message = finalizePhrases[Math.floor(Math.random() * finalizePhrases.length)].replace('{codigo}', codigo);
      typeWriter(title, message, 25);

      return new Promise(resolve => {
          const handleYesClick = () => { resolve(true); cleanup(); };
          const handleNoClick = () => { backdrop.classList.add('hidden'); resolve(false); cleanup(); };
          const cleanup = () => {
              yesBtn.removeEventListener('click', handleYesClick);
              noBtn.removeEventListener('click', handleNoClick);
          };
          yesBtn.addEventListener('click', handleYesClick, { once: true });
          noBtn.addEventListener('click', handleNoClick, { once: true });
      });
  }
  async function finalizarChamado(codigo) {
      if (!(await showFinalizeConfirmModal(codigo))) return;

      const backdrop = document.getElementById('confirm-finalize-backdrop');
      const initialView = document.getElementById('confirm-initial-view-finalize');
      const successView = document.getElementById('confirm-finalize-success-view');

      initialView.classList.add('content-hiding');
      setTimeout(() => {
          initialView.classList.add('hidden');
          successView.classList.remove('hidden');
      }, 300);
      
      try {
          const response = await fetch(`/api/chamado/finalizar/${codigo}/`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
              body: JSON.stringify({})
          });
          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || 'Falha ao finalizar o chamado.');
          }
          await new Promise(res => setTimeout(res, 1200));
          backdrop.classList.add('hidden');
          const chamadoElement = document.getElementById(`chamado-${codigo}`);
          if (chamadoElement) {
              chamadoElement.style.transition = 'opacity 0.5s ease, transform 0.5s ease, height 0.5s ease, margin 0.5s ease, padding 0.5s ease';
              chamadoElement.style.opacity = '0';
              chamadoElement.style.transform = 'scale(0.95)';
              chamadoElement.style.height = '0';
              chamadoElement.style.margin = '0';
              chamadoElement.style.padding = '0';
              setTimeout(() => chamadoElement.remove(), 500);
          }
      } catch (error) {
          backdrop.classList.add('hidden');
          alert(`Erro: ${error.message}`);
          console.error('Erro ao finalizar chamado:', error);
      }
  }

  document.addEventListener('DOMContentLoaded', () => {
    
    {% if user.is_authenticated %}
      document.getElementById("menu-dashboard").addEventListener("click", (e) => { e.preventDefault(); loadDashboard(); });
      document.getElementById("menu-chamados-abertos").addEventListener("click", (e) => { e.preventDefault(); loadAbertos(); });
      document.getElementById("menu-chamados-finalizados").addEventListener("click", (e) => { e.preventDefault(); loadChamadosFinalizados(); });
      
      loadDashboard();

      document.getElementById('content-area').addEventListener('click', function(e) {
          if (e.target.matches('.btn-fullscreen')) {
              e.stopPropagation();
              const convoContainer = e.target.closest('.conversa-wrapper').querySelector('.conversa-container');
              showConversationFullscreen(convoContainer);
          }
      });
      
    {% else %}
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', function (e) {
          e.preventDefault(); 
          document.body.classList.add('fade-zoom-out'); 
          setTimeout(() => loginForm.submit(), 400);
        });
      }
    {% endif %}

    const clockElement = document.getElementById('clock');
    function updateClock() {
      if (clockElement) {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        clockElement.textContent = `${hours}:${minutes}:${seconds}`;
      }
    }
    setInterval(updateClock, 1000); 
    updateClock();

    const themeToggle = document.getElementById('theme-checkbox');
    const body = document.body;
    const lightbulb = document.getElementById('lightbulb');
    const currentTheme = localStorage.getItem('theme');
    function applyTheme(theme) {
        if (theme === 'light') { body.classList.add('light-mode'); if(themeToggle) themeToggle.checked = true; } 
        else { body.classList.remove('light-mode'); if(themeToggle) themeToggle.checked = false; }
    }
    if (currentTheme) { applyTheme(currentTheme); }

    function animateBulb(mode) {
        if (!lightbulb) return;
        lightbulb.className = ''; 
        void lightbulb.offsetWidth;
        if (mode === 'light') { lightbulb.classList.add('animate-on'); } 
        else { lightbulb.classList.add('animate-off'); }
    }
    if (themeToggle) {
        themeToggle.addEventListener('change', () => {
            let newTheme = themeToggle.checked ? 'light' : 'dark';
            
            animateBulb(newTheme);
            
            setTimeout(() => { 
                applyTheme(newTheme); 
                localStorage.setItem('theme', newTheme); 
            }, 500);
        });
    }

    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const sidebar = document.getElementById('sidebar');
    const mainContainer = document.getElementById('main-container');
    if (menuToggleBtn && sidebar && mainContainer) {
        let hoverTimeout;
        const showSidebarOnHover = () => { 
            clearTimeout(hoverTimeout);
            sidebar.classList.add('sidebar-visible');
            mainContainer.classList.add('content-shifted'); 
        };
        const hideSidebarOnLeave = () => { 
            hoverTimeout = setTimeout(() => {
                sidebar.classList.remove('sidebar-visible');
                mainContainer.classList.remove('content-shifted');
            }, 300);
        };
        menuToggleBtn.addEventListener('mouseenter', showSidebarOnHover);
        sidebar.addEventListener('mouseenter', showSidebarOnHover);
        menuToggleBtn.addEventListener('mouseleave', hideSidebarOnLeave);
        sidebar.addEventListener('mouseleave', hideSidebarOnLeave);
    }
    
    const promptContainer = document.getElementById('inactive-prompt-container');
    if (promptContainer) {
        const promptText = document.getElementById('inactive-prompt-text');
        const phrases = ["Ainda est√° a√≠?", "O que acha de se mexer um pouco?", "Um caf√© cairia bem agora...", "Ei, psiu!", "Tudo certo por aqui?"];
        let inactivityTimer;
        let promptIsVisible = false;
        const INACTIVITY_TIME = 120000; 
        const showPrompt = () => {
            if (promptIsVisible) return;
            promptIsVisible = true;
            promptText.textContent = phrases[Math.floor(Math.random() * phrases.length)];
            promptContainer.classList.remove('hiding');
            promptContainer.classList.add('visible');
        };
        const hidePrompt = () => {
            if (!promptIsVisible) return;
            promptIsVisible = false;
            promptContainer.classList.add('hiding');
            setTimeout(() => { promptContainer.classList.remove('visible'); }, 500); 
        };
        const resetInactivityTimer = () => {
            hidePrompt();
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(showPrompt, INACTIVITY_TIME);
        };
        window.addEventListener('mousedown', resetInactivityTimer);
        window.addEventListener('keydown', resetInactivityTimer);
        resetInactivityTimer();
    }

    const settingsBtn = document.getElementById('settings-btn');
    if(settingsBtn) { 
        settingsBtn.addEventListener('click', showSettingsModal); 
    }

    const obsBackdrop = document.getElementById('obs-modal-backdrop');
    if (obsBackdrop) {
        const obsCloseBtn = document.getElementById('obs-modal-close-btn');
        const obsSendBtn = document.getElementById('obs-send-btn');
        const obsTextInput = document.getElementById('obs-text-input');
        const obsAttachBtn = document.getElementById('obs-attach-btn');
        const obsFileInput = document.getElementById('obs-file-input');
        const obsPreviewContainer = document.getElementById('obs-attachment-preview-container');

        const clearAttachment = () => {
            obsFileAttachment = null;
            obsFileInput.value = ''; 
            obsPreviewContainer.innerHTML = '';
        };

        const showAttachmentPreview = (file) => {
            obsFileAttachment = file;
            let previewHtml = '';
            if (file.type.startsWith('image/')) {
                previewHtml = `
                    <div class="obs-attachment-preview">
                        <img src="${URL.createObjectURL(file)}" class="obs-preview-thumbnail" alt="Preview">
                        <span class="obs-preview-name">${escapeHtml(file.name)}</span>
                        <button class="obs-remove-attachment" title="Remover anexo">&times;</button>
                    </div>`;
            } else {
                previewHtml = `
                    <div class="obs-attachment-preview">
                        <span class="document-icon">üìÑ</span>
                        <span class="obs-preview-name">${escapeHtml(file.name)}</span>
                        <button class="obs-remove-attachment" title="Remover anexo">&times;</button>
                    </div>`;
            }
            obsPreviewContainer.innerHTML = previewHtml;
            obsPreviewContainer.querySelector('.obs-remove-attachment').onclick = clearAttachment;
        };
        
        const hide = () => {
            clearAttachment();
            obsBackdrop.classList.add('hidden');
        };

        obsCloseBtn.onclick = hide;
        obsBackdrop.onclick = e => { if (e.target === obsBackdrop) hide(); };
        obsAttachBtn.onclick = () => obsFileInput.click();
        obsFileInput.onchange = () => {
            if (obsFileInput.files.length > 0) {
                showAttachmentPreview(obsFileInput.files[0]);
            }
        };
        
        obsTextInput.onpaste = (event) => {
            const items = (event.clipboardData || window.clipboardData).items;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    event.preventDefault();
                    const file = item.getAsFile();
                    showAttachmentPreview(file);
                    return;
                }
            }
        };

        obsSendBtn.onclick = async () => {
            const texto = obsTextInput.innerText.trim();
            const file = obsFileAttachment;

            if (!texto && !file) return;

            obsSendBtn.disabled = true;
            obsSendBtn.textContent = '...';
            const formData = new FormData();
            if (file && !file.type.startsWith('image/')) {
                 formData.append('texto', file.name);
            } else if (texto) {
                 formData.append('texto', texto);
            }

            if (file) formData.append('media_file', file);
            
            try {
                const response = await fetch(`/api/chamado/${currentObsCodigo}/observacoes/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken() },
                    body: formData,
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData));
                }
                const newObs = await response.json();
                const obsListContainer = document.getElementById('obs-list-container');
                const noObsMessage = obsListContainer.querySelector('.text-center');
                if (noObsMessage) noObsMessage.remove();
                
                obsListContainer.insertAdjacentHTML('beforeend', renderObservacao(newObs));
                obsListContainer.scrollTop = obsListContainer.scrollHeight;

                obsTextInput.innerHTML = '';
                clearAttachment();

            } catch (err) {
                alert('Erro ao enviar observa√ß√£o: ' + err.message);
            } finally {
                obsSendBtn.disabled = false;
                obsSendBtn.innerHTML = '‚ñ∂Ô∏è';
            }
        };

        obsTextInput.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                obsSendBtn.click();
            }
        };
    }
  });
</script>

</body>
</html>